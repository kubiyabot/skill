name: Publish to crates.io

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'true'
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    # Only run on release tags or manual workflow dispatch
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    # Using macOS due to Linux proc-macro compatibility issue with arg_enum_proc_macro
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            echo "Publishing release version: $VERSION"
          else
            VERSION="0.0.0-dry-run"
            echo "Dry run with test version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Inject versions into Cargo.toml files
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting all crate versions to: $VERSION"

          # Update each crate's version
          for crate in skill-context skill-runtime skill-web skill-mcp skill-http skill-cli; do
            sed -i.bak "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" "crates/$crate/Cargo.toml"
            echo "  Updated crates/$crate/Cargo.toml"
          done

          # Update workspace dependencies to include versions
          # From: skill-foo = { path = "crates/skill-foo" }
          # To:   skill-foo = { path = "crates/skill-foo", version = "X.Y.Z" }
          # Note: skill-web and skill-cli are not workspace deps (they're binaries)
          for crate in skill-context skill-runtime skill-mcp skill-http; do
            sed -i.bak "s|$crate = { path = \"crates/$crate\" }|$crate = { path = \"crates/$crate\", version = \"$VERSION\" }|" Cargo.toml
            echo "  Updated workspace dep: $crate"
          done

          # Cleanup backup files
          find . -name "*.bak" -delete

          echo ""
          echo "Verifying crate versions:"
          grep '^version' crates/*/Cargo.toml
          echo ""
          echo "Verifying workspace dependencies:"
          grep -E '^skill-' Cargo.toml

      - name: Verify build with injected versions
        run: cargo check --workspace

      - name: Publish crates
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          # For releases: always publish. For workflow_dispatch: respect dry_run input
          dry-run: ${{ github.event_name != 'release' && inputs.dry_run }}
          # Required: versions are injected at publish time (0.0.0 -> actual version)
          # The repo check would fail comparing git state vs modified working directory
          check-repo: false

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if this was a dry run
          if [[ "${{ github.event_name }}" != "release" && "${{ inputs.dry_run }}" == "true" ]]; then
            echo "### Dry Run" >> $GITHUB_STEP_SUMMARY
            echo "This was a dry run - no packages were actually published." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Published to crates.io" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| skill-context | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| skill-runtime | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| skill-web | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| skill-mcp | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| skill-http | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| skill-cli | $VERSION |" >> $GITHUB_STEP_SUMMARY
